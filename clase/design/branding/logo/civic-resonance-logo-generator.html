<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clara — Civic Resonance Logo Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Lora:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --anthropic-dark: #141413;
            --anthropic-light: #faf9f5;
            --anthropic-mid-gray: #b0aea5;
            --anthropic-light-gray: #e8e6dc;
            --anthropic-orange: #d97757;
            --anthropic-blue: #6a9bcc;
            --anthropic-green: #788c5d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--anthropic-light) 0%, #f5f3ee 100%);
            min-height: 100vh;
            color: var(--anthropic-dark);
        }
        .container { display: flex; min-height: 100vh; padding: 20px; gap: 20px; }
        .sidebar {
            width: 320px; flex-shrink: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 24px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(20,20,19,0.1);
            overflow-y: auto; overflow-x: hidden;
        }
        .sidebar h1 { font-family: 'Lora', serif; font-size: 24px; font-weight: 500; color: var(--anthropic-dark); margin-bottom: 8px; }
        .sidebar .subtitle { color: var(--anthropic-mid-gray); font-size: 14px; margin-bottom: 32px; line-height: 1.4; }
        .control-section { margin-bottom: 32px; }
        .control-section h3 {
            font-size: 16px; font-weight: 600; color: var(--anthropic-dark);
            margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
        }
        .control-section h3::before { content: '\2022'; color: var(--anthropic-orange); font-weight: bold; }
        .seed-input {
            width: 100%; background: var(--anthropic-light); padding: 12px; border-radius: 8px;
            font-family: 'Courier New', monospace; font-size: 14px; margin-bottom: 12px;
            border: 1px solid var(--anthropic-light-gray); text-align: center;
        }
        .seed-input:focus { outline: none; border-color: var(--anthropic-orange); box-shadow: 0 0 0 2px rgba(217,119,87,0.1); background: white; }
        .seed-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .regen-button { margin-bottom: 0; }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; font-size: 14px; font-weight: 500; color: var(--anthropic-dark); margin-bottom: 8px; }
        .slider-container { display: flex; align-items: center; gap: 12px; }
        .slider-container input[type="range"] { flex: 1; height: 4px; background: var(--anthropic-light-gray); border-radius: 2px; outline: none; -webkit-appearance: none; }
        .slider-container input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--anthropic-orange); border-radius: 50%; cursor: pointer; transition: all 0.2s ease; }
        .slider-container input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); background: #c86641; }
        .slider-container input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: var(--anthropic-orange); border-radius: 50%; border: none; cursor: pointer; }
        .value-display { font-family: 'Courier New', monospace; font-size: 12px; color: var(--anthropic-mid-gray); min-width: 60px; text-align: right; }
        .color-group { margin-bottom: 16px; }
        .color-group label { display: block; font-size: 12px; color: var(--anthropic-mid-gray); margin-bottom: 4px; }
        .color-picker-container { display: flex; align-items: center; gap: 8px; }
        .color-picker-container input[type="color"] { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; background: none; padding: 0; }
        .color-value { font-family: 'Courier New', monospace; font-size: 12px; color: var(--anthropic-mid-gray); }
        .button {
            background: var(--anthropic-orange); color: white; border: none; padding: 10px 16px;
            border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.2s ease; width: 100%;
        }
        .button:hover { background: #c86641; transform: translateY(-1px); }
        .button:active { transform: translateY(0); }
        .button.secondary { background: var(--anthropic-blue); }
        .button.secondary:hover { background: #5a8bb8; }
        .button.tertiary { background: var(--anthropic-green); }
        .button.tertiary:hover { background: #6b7b52; }
        .button-row { display: flex; gap: 8px; }
        .button-row .button { flex: 1; }
        .canvas-area { flex: 1; display: flex; align-items: center; justify-content: center; min-width: 0; }
        #canvas-container {
            width: 100%; max-width: 1000px; border-radius: 12px; overflow: hidden;
            box-shadow: 0 20px 40px rgba(20,20,19,0.1); background: white;
        }
        #canvas-container canvas { display: block; width: 100% !important; height: auto !important; }
        .loading { display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--anthropic-mid-gray); padding: 100px; }
        @media (max-width: 600px) { .container { flex-direction: column; } .sidebar { width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>Civic Resonance</h1>
            <div class="subtitle">Generative logo system for Clara — voice as visible form, speech bubble as resonant chamber</div>

            <!-- Seed Section (FIXED) -->
            <div class="control-section">
                <h3>Seed</h3>
                <input type="number" id="seed-input" class="seed-input" value="7" onchange="updateSeed()">
                <div class="seed-controls">
                    <button class="button secondary" onclick="previousSeed()">&#8592; Prev</button>
                    <button class="button secondary" onclick="nextSeed()">Next &#8594;</button>
                </div>
                <button class="button tertiary regen-button" onclick="randomSeedAndUpdate()">&#8635; Random</button>
            </div>

            <!-- Parameters Section (VARIABLE) -->
            <div class="control-section">
                <h3>Parameters</h3>

                <div class="control-group">
                    <label>Wave Sources</label>
                    <div class="slider-container">
                        <input type="range" id="waveSources" min="2" max="7" step="1" value="3" oninput="updateParam('waveSources', this.value)">
                        <span class="value-display" id="waveSources-value">3</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Bubble Roundness</label>
                    <div class="slider-container">
                        <input type="range" id="squircle" min="2.0" max="6.0" step="0.2" value="3.4" oninput="updateParam('squircle', this.value)">
                        <span class="value-display" id="squircle-value">3.4</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Wave Frequency</label>
                    <div class="slider-container">
                        <input type="range" id="waveFreq" min="0.02" max="0.12" step="0.005" value="0.06" oninput="updateParam('waveFreq', this.value)">
                        <span class="value-display" id="waveFreq-value">0.06</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Bar Count</label>
                    <div class="slider-container">
                        <input type="range" id="barCount" min="3" max="9" step="1" value="5" oninput="updateParam('barCount', this.value)">
                        <span class="value-display" id="barCount-value">5</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Diffusion</label>
                    <div class="slider-container">
                        <input type="range" id="diffusion" min="0.0" max="5.0" step="0.5" value="2.0" oninput="updateParam('diffusion', this.value)">
                        <span class="value-display" id="diffusion-value">2.0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Organic Noise</label>
                    <div class="slider-container">
                        <input type="range" id="organicNoise" min="0.0" max="1.0" step="0.05" value="0.25" oninput="updateParam('organicNoise', this.value)">
                        <span class="value-display" id="organicNoise-value">0.25</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Tail Size</label>
                    <div class="slider-container">
                        <input type="range" id="tailSize" min="0.0" max="1.0" step="0.05" value="0.4" oninput="updateParam('tailSize', this.value)">
                        <span class="value-display" id="tailSize-value">0.4</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Show Text</label>
                    <div class="slider-container">
                        <input type="range" id="showText" min="0" max="1" step="1" value="1" oninput="updateParam('showText', this.value)">
                        <span class="value-display" id="showText-value">On</span>
                    </div>
                </div>
            </div>

            <!-- Colors Section -->
            <div class="control-section">
                <h3>Colors</h3>
                <div class="color-group">
                    <label>Trust (Bubble)</label>
                    <div class="color-picker-container">
                        <input type="color" id="color1" value="#1B5E7B" onchange="updateColor('color1', this.value)">
                        <span class="color-value" id="color1-value">#1B5E7B</span>
                    </div>
                </div>
                <div class="color-group">
                    <label>Energy (Bars)</label>
                    <div class="color-picker-container">
                        <input type="color" id="color2" value="#D46A1E" onchange="updateColor('color2', this.value)">
                        <span class="color-value" id="color2-value">#D46A1E</span>
                    </div>
                </div>
                <div class="color-group">
                    <label>Hope (Accents)</label>
                    <div class="color-picker-container">
                        <input type="color" id="color3" value="#2E7D4F" onchange="updateColor('color3', this.value)">
                        <span class="color-value" id="color3-value">#2E7D4F</span>
                    </div>
                </div>
            </div>

            <!-- Actions Section (FIXED) -->
            <div class="control-section">
                <h3>Actions</h3>
                <div class="button-row" style="margin-bottom:8px">
                    <button class="button" onclick="resetParameters()">Reset</button>
                    <button class="button secondary" onclick="downloadPNG()">&#8681; PNG</button>
                </div>
            </div>
        </div>

        <div class="canvas-area">
            <div id="canvas-container">
                <div class="loading">Generating logo mark...</div>
            </div>
        </div>
    </div>

    <script>
    // ═══════════════════════════════════════════════════════════════
    // PARAMETERS
    // ═══════════════════════════════════════════════════════════════
    let params = {
        seed: 7,
        waveSources: 3,
        squircle: 3.4,
        waveFreq: 0.06,
        barCount: 5,
        diffusion: 2.0,
        organicNoise: 0.25,
        tailSize: 0.4,
        showText: 1,
        colorPalette: ['#1B5E7B', '#D46A1E', '#2E7D4F']
    };
    let defaultParams = JSON.parse(JSON.stringify(params));

    // ═══════════════════════════════════════════════════════════════
    // GENERATIVE ALGORITHM — Civic Resonance
    // ═══════════════════════════════════════════════════════════════
    let pg; // off-screen graphics for diffusion

    function setup() {
        let canvas = createCanvas(1200, 1200);
        canvas.parent('canvas-container');
        pg = createGraphics(1200, 1200);
        pixelDensity(1);
        generateLogo();
        document.querySelector('.loading').style.display = 'none';
    }

    function draw() { /* static — no animation loop */ }

    function generateLogo() {
        randomSeed(params.seed);
        noiseSeed(params.seed);
        background(250, 249, 245);
        pg.clear();

        let cx = width / 2;
        let cy = height * 0.44;
        let bw = width * 0.52;
        let bh = height * 0.38;
        let n = params.squircle;

        // ── Phase 1: Draw bubble on offscreen buffer ──
        pg.noStroke();

        // Bubble shadow
        pg.fill(20, 20, 19, 18);
        drawSuperellipse(pg, cx + 4, cy + 6, bw + 2, bh + 2, n);

        // Bubble body
        let bc = hexToP5(params.colorPalette[0]);
        pg.fill(bc);
        drawSuperellipse(pg, cx, cy, bw, bh, n);

        // ── Phase 1b: Tail ──
        if (params.tailSize > 0.05) {
            let ts = params.tailSize;
            let tx1 = cx - bw * 0.22;
            let ty1 = cy + bh * 0.48;
            let tx2 = cx - bw * (0.1 + ts * 0.35);
            let ty2 = cy + bh * (0.55 + ts * 0.55);
            let tx3 = cx + bw * 0.05;
            let ty3 = cy + bh * 0.48;
            pg.fill(bc);
            pg.triangle(tx1, ty1, tx2, ty2, tx3, ty3);
            // shadow
            pg.fill(20, 20, 19, 12);
            pg.triangle(tx1 + 3, ty1 + 4, tx2 + 3, ty2 + 4, tx3 + 3, ty3 + 4);
            // redraw body to cover shadow overlap
            pg.fill(bc);
            drawSuperellipse(pg, cx, cy, bw, bh, n);
        }

        // ── Phase 2: Sound wave bars inside bubble ──
        let barC = hexToP5(params.colorPalette[1]);
        let barCount = params.barCount;
        let barZoneW = bw * 0.7;
        let barZoneH = bh * 0.65;
        let barW = barZoneW / (barCount * 2 - 1);
        let startX = cx - barZoneW / 2 + barW / 2;

        // Generate bar heights using wave interference
        let sources = [];
        for (let s = 0; s < params.waveSources; s++) {
            sources.push({
                x: random(-0.5, 0.5),
                freq: (1 + s * 0.618) * params.waveFreq * 100,
                phase: random(TWO_PI),
                amp: 0.5 + random(0.5)
            });
        }

        let barHeights = [];
        for (let i = 0; i < barCount; i++) {
            let t = barCount > 1 ? i / (barCount - 1) - 0.5 : 0;
            let val = 0;
            for (let s of sources) {
                let d = abs(t - s.x);
                val += s.amp * cos(d * s.freq + s.phase);
            }
            // Add organic noise
            val += (noise(i * 1.3 + params.seed * 0.01) - 0.5) * params.organicNoise * 2;
            barHeights.push(abs(val));
        }

        // Normalize bar heights
        let maxH = Math.max(...barHeights, 0.001);
        barHeights = barHeights.map(h => 0.25 + 0.75 * (h / maxH));

        // Draw bars with rounded caps
        pg.fill(barC);
        pg.noStroke();
        for (let i = 0; i < barCount; i++) {
            let bx = startX + i * barW * 2;
            let h = barHeights[i] * barZoneH;
            let by = cy - h / 2;
            let r = Math.min(barW, h) * 0.5;

            // Slight organic wobble
            let wobX = (noise(i * 2.7, params.seed * 0.1) - 0.5) * params.organicNoise * barW * 0.6;
            let wobY = (noise(i * 3.1, params.seed * 0.2) - 0.5) * params.organicNoise * barZoneH * 0.08;

            pg.rect(bx + wobX - barW / 2, by + wobY, barW, h, r);
        }

        // ── Phase 2b: Subtle convergence dots (green accents) ──
        let gc = hexToP5(params.colorPalette[2]);
        pg.fill(gc[0], gc[1], gc[2], 80);
        let dotCount = Math.floor(3 + random(4));
        for (let d = 0; d < dotCount; d++) {
            let angle = random(TWO_PI);
            let radius = random(0.2, 0.4);
            let dx = cx + cos(angle) * bw * radius;
            let dy = cy + sin(angle) * bh * radius;
            let ds = 3 + random(6);
            pg.ellipse(dx, dy, ds, ds);
        }

        // ── Phase 3: Diffusion pass ──
        if (params.diffusion > 0.1) {
            // Soft glow by drawing multiple transparent copies offset
            let passes = Math.ceil(params.diffusion);
            let spread = params.diffusion * 1.2;
            image(pg, 0, 0); // base
            push();
            drawingContext.filter = `blur(${spread}px)`;
            tint(255, 30);
            image(pg, 0, 0);
            pop();
            // Redraw sharp on top
            tint(255, 255);
            image(pg, 0, 0);
        } else {
            image(pg, 0, 0);
        }

        // ── Phase 4: Text ──
        if (params.showText > 0.5) {
            let tc = hexToP5(params.colorPalette[0]);
            fill(tc);
            noStroke();
            textAlign(CENTER, CENTER);
            textFont('sans-serif');

            // "Clara" in bold
            textStyle(BOLD);
            textSize(width * 0.11);
            text('Clara', cx, cy + bh * 0.75 + height * 0.06);

            // Tagline
            fill(74, 74, 90);
            textStyle(NORMAL);
            textSize(width * 0.032);
            text('Tu voz tiene poder', cx, cy + bh * 0.75 + height * 0.13);
        }

        noLoop();
    }

    // ── Superellipse drawing ──
    function drawSuperellipse(g, cx, cy, rw, rh, n) {
        g.beginShape();
        let steps = 120;
        for (let i = 0; i <= steps; i++) {
            let a = (i / steps) * TWO_PI;
            let ca = cos(a);
            let sa = sin(a);
            let x = cx + Math.sign(ca) * Math.pow(abs(ca), 2 / n) * rw;
            let y = cy + Math.sign(sa) * Math.pow(abs(sa), 2 / n) * rh;
            g.vertex(x, y);
        }
        g.endShape(CLOSE);
    }

    // ── Color utility ──
    function hexToP5(hex) {
        let r = parseInt(hex.slice(1, 3), 16);
        let g = parseInt(hex.slice(3, 5), 16);
        let b = parseInt(hex.slice(5, 7), 16);
        return [r, g, b];
    }

    // ═══════════════════════════════════════════════════════════════
    // UI HANDLERS
    // ═══════════════════════════════════════════════════════════════
    function updateParam(name, value) {
        if (name === 'showText') {
            params[name] = parseInt(value);
            document.getElementById(name + '-value').textContent = parseInt(value) ? 'On' : 'Off';
        } else {
            params[name] = parseFloat(value);
            document.getElementById(name + '-value').textContent = value;
        }
        generateLogo();
    }

    function updateColor(id, value) {
        let idx = parseInt(id.replace('color', '')) - 1;
        params.colorPalette[idx] = value;
        document.getElementById(id + '-value').textContent = value;
        generateLogo();
    }

    function downloadPNG() {
        saveCanvas('clara-logo-seed-' + params.seed, 'png');
    }

    // ═══════════════════════════════════════════════════════════════
    // SEED CONTROLS (FIXED)
    // ═══════════════════════════════════════════════════════════════
    function updateSeedDisplay() { document.getElementById('seed-input').value = params.seed; }
    function updateSeed() {
        let v = parseInt(document.getElementById('seed-input').value);
        if (v && v > 0) { params.seed = v; generateLogo(); } else { updateSeedDisplay(); }
    }
    function previousSeed() { params.seed = Math.max(1, params.seed - 1); updateSeedDisplay(); generateLogo(); }
    function nextSeed() { params.seed++; updateSeedDisplay(); generateLogo(); }
    function randomSeedAndUpdate() { params.seed = Math.floor(Math.random() * 999999) + 1; updateSeedDisplay(); generateLogo(); }

    function resetParameters() {
        params = JSON.parse(JSON.stringify(defaultParams));
        document.getElementById('waveSources').value = params.waveSources;
        document.getElementById('waveSources-value').textContent = params.waveSources;
        document.getElementById('squircle').value = params.squircle;
        document.getElementById('squircle-value').textContent = params.squircle;
        document.getElementById('waveFreq').value = params.waveFreq;
        document.getElementById('waveFreq-value').textContent = params.waveFreq;
        document.getElementById('barCount').value = params.barCount;
        document.getElementById('barCount-value').textContent = params.barCount;
        document.getElementById('diffusion').value = params.diffusion;
        document.getElementById('diffusion-value').textContent = params.diffusion;
        document.getElementById('organicNoise').value = params.organicNoise;
        document.getElementById('organicNoise-value').textContent = params.organicNoise;
        document.getElementById('tailSize').value = params.tailSize;
        document.getElementById('tailSize-value').textContent = params.tailSize;
        document.getElementById('showText').value = params.showText;
        document.getElementById('showText-value').textContent = params.showText ? 'On' : 'Off';
        document.getElementById('color1').value = params.colorPalette[0];
        document.getElementById('color1-value').textContent = params.colorPalette[0];
        document.getElementById('color2').value = params.colorPalette[1];
        document.getElementById('color2-value').textContent = params.colorPalette[1];
        document.getElementById('color3').value = params.colorPalette[2];
        document.getElementById('color3-value').textContent = params.colorPalette[2];
        updateSeedDisplay();
        generateLogo();
    }

    window.addEventListener('load', function() { updateSeedDisplay(); });
    </script>
</body>
</html>

# Q1.1 Biblioteca Oficial v0 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Convert Q1 research docs (markdown) into machine-readable artifacts (YAML/JSON), validation scripts, and a link checker skeleton — creating an operational "Biblioteca Oficial v0" for Spanish government procedures.

**Architecture:** Q1 produced 9 markdown research documents cataloging 25 AGE sources, 19 CCAA profiles, 20 municipal sedes, domain governance policies, and a ProcedureDoc schema. This task converts that research into structured data files (`data/sources/`, `data/policy/`), JSON Schemas (`schemas/`), and executable validation/checking scripts (`scripts/`). No `src/` changes — all new artifacts live in data/schemas/scripts/docs.

**Tech Stack:** Python 3.14, PyYAML (installed), jsonschema (to install), JSON Schema Draft 2020-12, YAML 1.2

---

### Task 1: Project Scaffolding + Dependencies

**Files:**
- Create: `data/sources/README.md`
- Create: `data/policy/README.md`
- Create: `schemas/README.md`

**Step 1: Install jsonschema**

Run: `pip3 install jsonschema`
Expected: Successfully installed jsonschema-x.x.x

**Step 2: Create directory structure**

Run:
```bash
mkdir -p data/sources data/policy schemas
```

**Step 3: Write data/sources/README.md**

```markdown
# Source Registry

Machine-readable catalog of official Spanish government sources for Clara's RAG system.

## Files

| File | Description |
|------|-------------|
| `registry.yaml` | All AGE + CCAA sources (25 AGE + 19 CCAA = 44 entries) |
| `local_seed.yaml` | Top 20 municipal sedes + Tier 2-4 strategy metadata |

## How to Add a Source

1. Add a new entry under the appropriate `jurisdiction` section in `registry.yaml`
2. Required fields: `id`, `name`, `jurisdiction`, `tier`, `portal_url`, `sede_url`, `priority`, `access_method`
3. Run validation: `python3 scripts/validate_source_registry.py`
4. If the source has a new domain, also add it to `data/policy/allowlist.yaml`

## Schema

See `schemas/SourceRegistry.v1.schema.json` for the full validation schema.
```

**Step 4: Write data/policy/README.md**

```markdown
# Link Governance Policy

Machine-readable rules for domain trust, URL canonicalization, and citation governance.

## Files

| File | Description |
|------|-------------|
| `allowlist.yaml` | Domains Clara may crawl/cite, organized by tier |
| `blocklist.yaml` | Domains always rejected (commercial, SEO, forums, etc.) |
| `canonical_rules.yaml` | URL normalization rules (10 rules) + params to strip |

## How the Policy is Applied

1. **Crawl time:** Before fetching any URL, check `allowlist.yaml`. Reject if not listed (or if in `blocklist.yaml`).
2. **Store time:** Canonicalize every URL using rules in `canonical_rules.yaml` before storing.
3. **Cite time:** Clara only cites URLs from Tier 1-3 allowed domains. Prefer informative links over homepages.

## Validation

Run: `python3 scripts/validate_policy.py`
```

**Step 5: Write schemas/README.md**

```markdown
# JSON Schemas

Validation schemas for Clara's data artifacts.

## Files

| File | Description |
|------|-------------|
| `SourceRegistry.v1.schema.json` | Schema for `data/sources/registry.yaml` and `local_seed.yaml` |
| `ProcedureDoc.v1.schema.json` | Schema for normalized procedure documents (future `data/ingested/`) |

## Usage

```bash
# Validate source registry
python3 scripts/validate_source_registry.py

# Validate a ProcedureDoc
python3 scripts/validate_proceduredoc_schema.py data/tramites/imv.json

# Validate policy files
python3 scripts/validate_policy.py
```
```

**Step 6: Commit**

```bash
git add data/sources/README.md data/policy/README.md schemas/README.md
git commit -m "feat(q1.1): scaffold data/sources, data/policy, schemas directories"
```

---

### Task 2: SourceRegistry JSON Schema

**Files:**
- Create: `schemas/SourceRegistry.v1.schema.json`

**Step 1: Write the schema**

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://civicaid-voice/schemas/SourceRegistry.v1.schema.json",
  "title": "Source Registry v1",
  "description": "Catalog of official Spanish government sources for CivicAid RAG system",
  "type": "object",
  "required": ["version", "generated_at", "sources"],
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0"
    },
    "generated_at": {
      "type": "string",
      "format": "date"
    },
    "sources": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/Source" }
    }
  },
  "$defs": {
    "Source": {
      "type": "object",
      "required": ["id", "name", "jurisdiction", "tier", "priority", "portal_url", "access_method"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_-]{2,60}$",
          "description": "Unique identifier, lowercase with hyphens/underscores"
        },
        "name": {
          "type": "string",
          "minLength": 3
        },
        "name_abbrev": {
          "type": "string",
          "description": "Common abbreviation (e.g. SEPE, AEAT)"
        },
        "jurisdiction": {
          "type": "string",
          "enum": ["age", "ccaa", "local"]
        },
        "ccaa_code": {
          "type": "string",
          "description": "CCAA identifier (e.g. 'madrid', 'cataluna'). Required if jurisdiction=ccaa"
        },
        "municipality": {
          "type": "string",
          "description": "Municipality name. Required if jurisdiction=local"
        },
        "province": {
          "type": "string",
          "description": "Province name. Optional, used for local sources"
        },
        "tier": {
          "type": "integer",
          "minimum": 1,
          "maximum": 3,
          "description": "Trust tier: 1=AGE core, 2=CCAA, 3=Municipal"
        },
        "priority": {
          "type": "string",
          "enum": ["P0", "P1", "P2"],
          "description": "Crawl/ingestion priority"
        },
        "portal_url": {
          "type": "string",
          "format": "uri"
        },
        "sede_url": {
          "type": ["string", "null"],
          "format": "uri",
          "description": "Sede electronica URL if different from portal"
        },
        "catalogo_url": {
          "type": ["string", "null"],
          "format": "uri",
          "description": "URL to procedure catalog/listing"
        },
        "api_url": {
          "type": ["string", "null"],
          "format": "uri",
          "description": "REST/SOAP API endpoint if available"
        },
        "access_method": {
          "type": "string",
          "enum": ["crawl", "api", "rss", "auth_only", "informational"],
          "description": "Primary method for data acquisition"
        },
        "content_formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["html", "pdf", "xml", "json", "csv", "soap"]
          }
        },
        "languages": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["es", "ca", "eu", "gl", "va", "an"]
          },
          "default": ["es"]
        },
        "rate_limit_rps": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 10,
          "default": 1.0,
          "description": "Max requests per second for this source"
        },
        "update_frequency": {
          "type": "string",
          "enum": ["daily", "weekly", "monthly", "quarterly", "annual", "continuous", "unknown"]
        },
        "coverage": {
          "type": "string",
          "description": "What procedures/content this source covers"
        },
        "notes": {
          "type": "string"
        }
      },
      "if": {
        "properties": { "jurisdiction": { "const": "ccaa" } }
      },
      "then": {
        "required": ["ccaa_code"]
      }
    }
  }
}
```

**Step 2: Commit**

```bash
git add schemas/SourceRegistry.v1.schema.json
git commit -m "feat(q1.1): add SourceRegistry v1 JSON Schema"
```

---

### Task 3: Convert AGE + CCAA Sources → registry.yaml

**Files:**
- Create: `data/sources/registry.yaml`
- Reference: `docs/arreglos chat/fase-3/q1-sources/source-registry/age.md` (25 sources)
- Reference: `docs/arreglos chat/fase-3/q1-sources/source-registry/ccaa.md` (19 CCAA)

**Step 1: Write registry.yaml**

Extract ALL sources from the Q1 research docs. Every URL must come directly from `age.md` or `ccaa.md` — do NOT invent URLs.

The file must contain exactly:
- 25 AGE sources (from age.md summary table + detailed profiles)
- 19 CCAA sources (from ccaa.md, one entry per autonomous community/city)
- Total: 44 entries

Structure:

```yaml
version: "1.0"
generated_at: "2026-02-18"

sources:
  # === AGE (Administracion General del Estado) — 25 sources ===

  - id: age-sia-pag
    name: "SIA / Punto de Acceso General"
    name_abbrev: "SIA/PAG"
    jurisdiction: age
    tier: 1
    priority: P0
    portal_url: "https://administracion.gob.es/"
    sede_url: "https://sede.administracion.gob.es/"
    catalogo_url: null
    api_url: null
    access_method: crawl
    content_formats: [html]
    languages: [es, ca, eu, gl]
    rate_limit_rps: 1.0
    update_frequency: continuous
    coverage: "Master catalog of ALL administrative procedures across AGE"
    notes: "Managed by Dir. General de Gobernanza Publica. Feeds procedure pages."

  - id: age-boe-diario
    name: "BOE - Boletin Oficial del Estado (Diario)"
    name_abbrev: "BOE"
    jurisdiction: age
    tier: 1
    priority: P0
    portal_url: "https://www.boe.es/"
    sede_url: null
    catalogo_url: null
    api_url: "https://boe.es/datosabiertos/api/boe/sumario/"
    access_method: api
    content_formats: [xml, html, pdf]
    languages: [es]
    rate_limit_rps: 1.0
    update_frequency: daily
    coverage: "Official state gazette: laws, royal decrees, aid announcements"
    notes: "REST API, no auth. Best-documented gov API in Spain."

  - id: age-boe-legislacion
    name: "BOE - Legislacion Consolidada"
    name_abbrev: "BOE-LC"
    jurisdiction: age
    tier: 1
    priority: P0
    portal_url: "https://www.boe.es/buscar/legislacion.php"
    sede_url: null
    catalogo_url: null
    api_url: "https://www.boe.es/datosabiertos/api/legislacion-consolidada"
    access_method: api
    content_formats: [xml, html, pdf]
    languages: [es]
    rate_limit_rps: 1.0
    update_frequency: continuous
    coverage: "Consolidated (up-to-date) Spanish legislation"
    notes: "Always cite consolidated version, not original publication."

  # ... (continue for all 25 AGE + 19 CCAA sources)
  # IMPORTANT: Extract exact URLs from age.md and ccaa.md docs
```

For the remaining 22 AGE sources, use the data from the `age.md` summary table (lines 10-36) and detailed profiles. Map each source's fields:
- `id`: derive from `age-{abbreviation}` pattern
- `portal_url`: from the URL column in summary table
- `sede_url`: from detailed profile (if different from portal)
- `api_url`: from detailed profile (BOE, INE, datos.gob.es, Catastro)
- `priority`: from Priority column (P0/P1/P2)
- `access_method`: from Appendix B access method summary
- `coverage`: from Coverage column

For the 19 CCAA sources, use `ccaa.md` summary table. Map each community:
- `id`: `ccaa-{community_code}` (e.g. `ccaa-madrid`, `ccaa-cataluna`)
- `ccaa_code`: lowercase community name
- `portal_url`: main government portal from ccaa.md
- `sede_url`: sede electronica URL from ccaa.md
- `catalogo_url`: catalogo tramites URL from ccaa.md
- `languages`: include co-official languages (ca for Cataluna/Valencia/Balears, eu for Pais Vasco/Navarra, gl for Galicia)
- `priority`: from ccaa.md priority ranking (P0 for Madrid/Cataluna/Andalucia/Valencia/Canarias)

**Step 2: Run validation**

Run: `python3 scripts/validate_source_registry.py`
Expected: PASS (after Task 6 creates the validator — for now, manually count 44 entries)

**Step 3: Commit**

```bash
git add data/sources/registry.yaml
git commit -m "feat(q1.1): add source registry YAML (25 AGE + 19 CCAA = 44 sources)"
```

---

### Task 4: Convert Local Seed → local_seed.yaml

**Files:**
- Create: `data/sources/local_seed.yaml`
- Reference: `docs/arreglos chat/fase-3/q1-sources/source-registry/local.md`

**Step 1: Write local_seed.yaml**

Extract the top 20 cities from `local.md` Tier 1 table (lines 20-41). Every URL must come directly from that document.

```yaml
version: "1.0"
generated_at: "2026-02-18"

tier_strategy:
  tier_1:
    description: "Top 20 cities by population, manually curated"
    count: 20
    coverage_pct: "~30% of Spain's population"
    method: manual_curation
  tier_2:
    description: "Provincial capitals + cities 21-50"
    count_estimate: 50
    method: semi_automated_dir3_pag
  tier_3:
    description: "Cities >50,000 inhabitants"
    count_estimate: 100
    method: automated_with_validation
  tier_4:
    description: "Remaining ~7,900 municipalities"
    method: directory_fallback

core_procedures:
  - empadronamiento
  - certificado_empadronamiento
  - ibi
  - tasa_basuras
  - licencias_actividad

sources:
  - id: local-madrid
    name: "Ayuntamiento de Madrid"
    jurisdiction: local
    tier: 3
    priority: P0
    municipality: "Madrid"
    province: "Madrid"
    population: 3300000
    portal_url: "https://sede.madrid.es/"
    sede_url: "https://sede.madrid.es/"
    catalogo_url: "https://sede.madrid.es/portal/site/tramites"
    access_method: crawl
    content_formats: [html, pdf]
    languages: [es]
    rate_limit_rps: 1.0
    update_frequency: monthly
    coverage: "Municipal procedures: empadronamiento, IBI, licencias"
    notes: "Largest city. High immigrant population."

  - id: local-barcelona
    name: "Ajuntament de Barcelona"
    jurisdiction: local
    tier: 3
    priority: P0
    municipality: "Barcelona"
    province: "Barcelona"
    population: 1660000
    portal_url: "https://seuelectronica.ajuntament.barcelona.cat/es"
    sede_url: "https://seuelectronica.ajuntament.barcelona.cat/es"
    catalogo_url: "https://seuelectronica.ajuntament.barcelona.cat/es/tramites-telematicos"
    access_method: crawl
    content_formats: [html, pdf]
    languages: [es, ca]
    rate_limit_rps: 1.0
    update_frequency: monthly
    coverage: "Municipal procedures"
    notes: "Catalan bilingual. Prefer Spanish-language pages."

  # ... (continue for all 20 cities from local.md table)
  # Extract exact URLs from local.md lines 20-41
```

Map ALL 20 cities from the table in `local.md`:
Madrid, Barcelona, Valencia, Sevilla, Zaragoza, Malaga, Murcia, Palma, Las Palmas, Bilbao, Alicante, Cordoba, Valladolid, Vigo, Gijon, L'Hospitalet, Vitoria-Gasteiz, A Coruna, Granada, Elche.

**Step 2: Commit**

```bash
git add data/sources/local_seed.yaml
git commit -m "feat(q1.1): add local seed YAML (top 20 cities with verified URLs)"
```

---

### Task 5: Convert Governance Policies → YAML

**Files:**
- Create: `data/policy/allowlist.yaml`
- Create: `data/policy/blocklist.yaml`
- Create: `data/policy/canonical_rules.yaml`
- Reference: `docs/arreglos chat/fase-3/q1-sources/link-governance/allowlist.md`
- Reference: `docs/arreglos chat/fase-3/q1-sources/link-governance/canonicalization.md`

**Step 1: Write allowlist.yaml**

Extract domains from `allowlist.md` Tier 1 (lines 22-47), Tier 2 (lines 64-85), Tier 3 (lines 106-119).

```yaml
version: "1.0"
generated_at: "2026-02-18"
default_action: reject

auto_allow_rules:
  - pattern: "*.gob.es"
    tier: 1
    description: "All AGE subdomains"
  - pattern: "*.cat"
    tier: 2
    condition: "root domain in CCAA list"
    description: "Catalan regional TLD"
  - pattern: "*.eus"
    tier: 2
    condition: "root domain in CCAA list"
    description: "Basque regional TLD"
  - pattern: "*.gal"
    tier: 2
    condition: "root domain in CCAA list"
    description: "Galician regional TLD"

tier_1_age:
  - domain: "administracion.gob.es"
    entity: "Portal de la Administracion"
  - domain: "sede.administracion.gob.es"
    entity: "Sede electronica AGE"
  - domain: "boe.es"
    entity: "Boletin Oficial del Estado"
  - domain: "www.boe.es"
    entity: "BOE (www)"
  - domain: "seg-social.es"
    entity: "Seguridad Social"
  - domain: "sede.seg-social.gob.es"
    entity: "Sede Seguridad Social"
  - domain: "sepe.es"
    entity: "SEPE"
  - domain: "sede.sepe.gob.es"
    entity: "Sede SEPE"
  - domain: "agenciatributaria.es"
    entity: "Agencia Tributaria"
  - domain: "agenciatributaria.gob.es"
    entity: "AEAT (gob.es)"
  - domain: "dgt.es"
    entity: "DGT"
  - domain: "sede.dgt.gob.es"
    entity: "Sede DGT"
  - domain: "inclusion.gob.es"
    entity: "Min. Inclusion"
  - domain: "mites.gob.es"
    entity: "Min. Trabajo"
  - domain: "mjusticia.gob.es"
    entity: "Min. Justicia"
  - domain: "sede.mjusticia.gob.es"
    entity: "Sede Min. Justicia"
  - domain: "exteriores.gob.es"
    entity: "Min. Asuntos Exteriores"
  - domain: "mdsocialesa2030.gob.es"
    entity: "Min. Derechos Sociales"
  - domain: "mitma.gob.es"
    entity: "Min. Transportes"
  - domain: "educacionyfp.gob.es"
    entity: "Min. Educacion"
  - domain: "mscbs.gob.es"
    entity: "Min. Sanidad"
  - domain: "sanidad.gob.es"
    entity: "Sanidad (alt)"
  - domain: "interior.gob.es"
    entity: "Min. Interior"
  - domain: "policia.es"
    entity: "Policia Nacional"
  - domain: "sede.policia.gob.es"
    entity: "Sede Policia Nacional"
  - domain: "map.gob.es"
    entity: "Min. Admin Publicas"
  - domain: "060.es"
    entity: "Punto de Acceso General"
  - domain: "carpetaciudadana.gob.es"
    entity: "Carpeta Ciudadana"
  - domain: "clave.gob.es"
    entity: "Sistema Clave"

tier_2_ccaa:
  - domain: "comunidad.madrid"
    ccaa: "Madrid"
  - domain: "sede.comunidad.madrid"
    ccaa: "Madrid"
  - domain: "web.gencat.cat"
    ccaa: "Cataluna"
  - domain: "tramits.gencat.cat"
    ccaa: "Cataluna"
  - domain: "juntadeandalucia.es"
    ccaa: "Andalucia"
  - domain: "gva.es"
    ccaa: "Comunitat Valenciana"
  - domain: "sede.gva.es"
    ccaa: "Comunitat Valenciana"
  - domain: "gobiernodecanarias.org"
    ccaa: "Canarias"
  - domain: "euskadi.eus"
    ccaa: "Pais Vasco"
  - domain: "sede.euskadi.eus"
    ccaa: "Pais Vasco"
  - domain: "xunta.gal"
    ccaa: "Galicia"
  - domain: "sede.xunta.gal"
    ccaa: "Galicia"
  - domain: "navarra.es"
    ccaa: "Navarra"
  - domain: "aragon.es"
    ccaa: "Aragon"
  - domain: "sede.aragon.es"
    ccaa: "Aragon"
  - domain: "castillalamancha.es"
    ccaa: "Castilla-La Mancha"
  - domain: "jcyl.es"
    ccaa: "Castilla y Leon"
  - domain: "sede.jcyl.es"
    ccaa: "Castilla y Leon"
  - domain: "carm.es"
    ccaa: "Murcia"
  - domain: "sede.carm.es"
    ccaa: "Murcia"
  - domain: "larioja.org"
    ccaa: "La Rioja"
  - domain: "asturias.es"
    ccaa: "Asturias"
  - domain: "cantabria.es"
    ccaa: "Cantabria"
  - domain: "caib.es"
    ccaa: "Illes Balears"
  - domain: "extremadura.es"
    ccaa: "Extremadura"
  - domain: "sede.juntaex.es"
    ccaa: "Extremadura"
  - domain: "ceuta.es"
    ccaa: "Ceuta"
  - domain: "melilla.es"
    ccaa: "Melilla"

tier_3_municipal:
  - domain: "madrid.es"
    municipality: "Madrid"
  - domain: "sede.madrid.es"
    municipality: "Madrid"
  - domain: "barcelona.cat"
    municipality: "Barcelona"
  - domain: "ajuntament.barcelona.cat"
    municipality: "Barcelona"
  - domain: "sevilla.org"
    municipality: "Sevilla"
  - domain: "valencia.es"
    municipality: "Valencia"
  - domain: "sede.valencia.es"
    municipality: "Valencia"
  - domain: "zaragoza.es"
    municipality: "Zaragoza"
  - domain: "malaga.eu"
    municipality: "Malaga"
  - domain: "bilbao.eus"
    municipality: "Bilbao"
  - domain: "alicante.es"
    municipality: "Alicante"
  - domain: "cordoba.es"
    municipality: "Cordoba"
  - domain: "valladolid.es"
    municipality: "Valladolid"
  - domain: "laspalmasgc.es"
    municipality: "Las Palmas"
  - domain: "santacruzdetenerife.es"
    municipality: "Santa Cruz"
```

**Step 2: Write blocklist.yaml**

Extract from `allowlist.md` lines 130-155.

```yaml
version: "1.0"
generated_at: "2026-02-18"

categories:
  - category: "commercial_gestoria"
    reason: "Commercial advisory, may have outdated/biased info"
    domains:
      - "loentiendo.com"
      - "tramitalia.com"
      - "emigralia.es"
      - "parainmigrantes.info"

  - category: "seo_content_farms"
    reason: "SEO-optimized, not authoritative"
    domains:
      - "rankia.com"
      - "asesorias.com"
      - "supercontable.com"

  - category: "forums_qa"
    reason: "User-generated, unverified"
    domains:
      - "forocoches.com"
      - "burbuja.info"

  - category: "social_media"
    reason: "Not authoritative sources"
    domains:
      - "twitter.com"
      - "facebook.com"
      - "instagram.com"
      - "tiktok.com"

  - category: "wikipedia"
    reason: "Reference but not primary source"
    domains:
      - "es.wikipedia.org"

  - category: "news"
    reason: "Journalism, not primary source"
    domains:
      - "elpais.com"
      - "elmundo.es"
      - "20minutos.es"

  - category: "unofficial_aggregators"
    reason: "Appear official but are not"
    domains:
      - "tramitesygestiones.com"
      - "extranjeria.info"

  - category: "legal_commercial"
    reason: "Commercial interpretation of law"
    domains:
      - "noticias.juridicas.com"
      - "vlex.es"

patterns:
  - "*.wordpress.com"
  - "*.blogspot.com"
  - "*.medium.com"
  - "*.notion.site"
```

**Step 3: Write canonical_rules.yaml**

Extract from `canonicalization.md` (10 rules + param lists).

```yaml
version: "1.0"
generated_at: "2026-02-18"

pipeline_order:
  - parse
  - normalize_protocol
  - lowercase_domain
  - strip_session_params
  - strip_tracking_params
  - strip_fragment
  - remove_trailing_slash
  - follow_redirects
  - normalize_www
  - detect_language_variant
  - annotate_pagination
  - classify_link_type

rules:
  - id: 1
    name: "protocol_https"
    description: "Normalize to HTTPS"
    action: "Replace http:// with https://"

  - id: 2
    name: "trailing_slash"
    description: "Remove trailing slashes"
    action: "Strip trailing / from path"
    exception: "Keep if removing causes redirect to different page"

  - id: 3
    name: "strip_tracking_params"
    description: "Remove tracking and analytics parameters"
    action: "Remove listed query parameters"

  - id: 4
    name: "strip_fragment"
    description: "Remove URL fragment/anchor"
    action: "Strip #fragment, log separately"

  - id: 5
    name: "www_normalization"
    description: "Follow domain's canonical www form"
    action: "Issue HEAD request, follow redirects, cache mapping"

  - id: 6
    name: "case_normalization"
    description: "Lowercase domain, preserve path case"
    action: "domain.lower(), keep path as-is"

  - id: 7
    name: "follow_redirects"
    description: "Store final URL after redirect chain"
    action: "Follow 301/302/303/307/308, max 5 hops"

  - id: 8
    name: "strip_session_params"
    description: "Remove server-side session identifiers"
    action: "Remove listed session parameters from path and query"

  - id: 9
    name: "pagination"
    description: "Store base URL, annotate pagination"
    action: "Strip page param, store metadata separately"

  - id: 10
    name: "language_variants"
    description: "Prefer Spanish, note other languages"
    action: "Select es/cas/castellano version as canonical"

tracking_params_strip:
  - "utm_source"
  - "utm_medium"
  - "utm_campaign"
  - "utm_term"
  - "utm_content"
  - "fbclid"
  - "gclid"
  - "gad_source"
  - "ref"
  - "source"
  - "origin"
  - "mc_cid"
  - "mc_eid"
  - "_ga"
  - "_gl"
  - "hsCtaTracking"
  - "mkt_tok"

session_params_strip:
  - "JSESSIONID"
  - "PHPSESSID"
  - "sid"
  - "session_id"
  - "cfid"
  - "cftoken"

content_params_preserve:
  - "lang"
  - "idioma"
  - "locale"
  - "id"
  - "codigo"
  - "expediente"
  - "page"
  - "pagina"
  - "p"
  - "tipo"
  - "category"
  - "seccion"

www_mappings:
  "boe.es": "www.boe.es"
  "sepe.es": "www.sepe.es"
  "seg-social.es": "www.seg-social.es"
  "agenciatributaria.es": "sede.agenciatributaria.gob.es"
```

**Step 4: Commit**

```bash
git add data/policy/allowlist.yaml data/policy/blocklist.yaml data/policy/canonical_rules.yaml
git commit -m "feat(q1.1): add governance policy YAML (allowlist + blocklist + canonical rules)"
```

---

### Task 6: ProcedureDoc v1 JSON Schema

**Files:**
- Create: `schemas/ProcedureDoc.v1.schema.json`
- Reference: `docs/arreglos chat/fase-3/q1-sources/ingestion/normalization-schema.md`

**Step 1: Write the JSON Schema**

Convert the ProcedureDoc v1 spec from `normalization-schema.md` into a proper JSON Schema. Use all fields from the field reference table and validation rules described in that document.

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://civicaid-voice/schemas/ProcedureDoc.v1.schema.json",
  "title": "ProcedureDoc v1",
  "description": "Normalized Spanish government procedure document for CivicAid RAG",
  "type": "object",
  "required": ["id", "nombre", "source_url", "source_type", "organismo", "descripcion", "keywords", "idioma", "extracted_at", "content_hash", "word_count", "completeness_score", "version"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_-]{2,80}$",
      "description": "Unique identifier: {source_type}-{organismo_abrev}-{slug}"
    },
    "nombre": {
      "type": "string",
      "minLength": 5,
      "description": "Official procedure name"
    },
    "nombre_alternativo": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Alternative names, colloquial terms, translations"
    },
    "source_url": {
      "type": "string",
      "format": "uri",
      "description": "Primary canonical source URL"
    },
    "source_urls": {
      "type": "array",
      "items": { "type": "string", "format": "uri" },
      "description": "All source URLs consulted"
    },
    "source_type": {
      "type": "string",
      "enum": ["age", "ccaa", "local", "boe"]
    },
    "organismo": {
      "type": "string",
      "description": "Full name of responsible organization"
    },
    "organismo_abrev": {
      "type": "string",
      "description": "Abbreviation (e.g. SEPE, AEAT, INSS)"
    },
    "territorio": {
      "type": "object",
      "required": ["nivel"],
      "properties": {
        "nivel": { "type": "string", "enum": ["estatal", "autonomico", "local"] },
        "ccaa": { "type": "string" },
        "municipio": { "type": "string" },
        "provincia": { "type": "string" }
      }
    },
    "canal": {
      "type": "string",
      "enum": ["electronico", "presencial", "mixto"]
    },
    "descripcion": {
      "type": "string",
      "minLength": 20,
      "description": "What the procedure is and who it's for"
    },
    "requisitos": {
      "oneOf": [
        { "type": "string" },
        { "type": "array", "items": { "type": "string" } }
      ],
      "description": "Eligibility requirements"
    },
    "documentos_necesarios": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Documents needed to apply"
    },
    "plazos": {
      "oneOf": [
        { "type": "string" },
        { "type": "object" }
      ],
      "description": "Deadlines and timeframes"
    },
    "tasas": {
      "type": ["string", "null"],
      "description": "Fees or costs"
    },
    "base_legal": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Legal references (BOE IDs, law names)"
    },
    "como_solicitar": {
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "online": { "type": "string" },
            "presencial": { "type": "string" },
            "telefono": { "type": "string" }
          }
        },
        {
          "type": "array",
          "items": { "type": "object" }
        }
      ],
      "description": "How to apply"
    },
    "donde_solicitar": {
      "type": "object",
      "properties": {
        "urls": { "type": "array", "items": { "type": "string", "format": "uri" } },
        "direcciones": { "type": "array", "items": { "type": "string" } },
        "cita_previa_url": { "type": ["string", "null"], "format": "uri" }
      }
    },
    "keywords": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 3,
      "description": "Search keywords for kb_lookup.py"
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" }
    },
    "idioma": {
      "type": "string",
      "enum": ["es", "ca", "eu", "gl", "en"]
    },
    "idiomas_disponibles": {
      "type": "array",
      "items": { "type": "string" }
    },
    "extracted_at": {
      "type": "string",
      "format": "date-time"
    },
    "verified_at": {
      "type": ["string", "null"],
      "format": "date-time"
    },
    "verified_by": {
      "type": ["string", "null"],
      "enum": ["manual", "auto", null]
    },
    "content_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 of normalized text body"
    },
    "word_count": {
      "type": "integer",
      "minimum": 1
    },
    "completeness_score": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0
    },
    "version": {
      "type": "integer",
      "const": 1
    }
  }
}
```

**Step 2: Create a sample ProcedureDoc that validates**

Create file: `docs/arreglos chat/fase-3/q1-sources/evidence/samples/proceduredoc.sample.json`

Based on the existing `data/tramites/imv.json`, create a ProcedureDoc v1 version:

```json
{
  "id": "age-segsocial-ingreso-minimo-vital",
  "nombre": "Ingreso Minimo Vital (IMV)",
  "nombre_alternativo": ["IMV", "Ingreso minimo", "Renta minima", "Ayuda economica"],
  "source_url": "https://www.seg-social.es/wps/portal/wss/internet/Trabajadores/PrestacionesPensionesTrabajadores/65850d68-8d06-4645-bde7-05374ee42ac7",
  "source_urls": ["https://www.seg-social.es/wps/portal/wss/internet/Trabajadores/PrestacionesPensionesTrabajadores/65850d68-8d06-4645-bde7-05374ee42ac7", "https://www.inclusion.gob.es/web/imv"],
  "source_type": "age",
  "organismo": "Seguridad Social (INSS)",
  "organismo_abrev": "INSS",
  "territorio": { "nivel": "estatal" },
  "canal": "mixto",
  "descripcion": "Prestacion economica dirigida a prevenir el riesgo de pobreza y exclusion social de personas que vivan solas o integradas en una unidad de convivencia y carezcan de recursos economicos basicos.",
  "requisitos": [
    "Tener entre 23 y 65 anos (excepciones: menores con hijos, mayores de 65 sin pension)",
    "Residencia legal y efectiva en Espana durante al menos 1 ano continuado",
    "Estar en situacion de vulnerabilidad economica",
    "Haber solicitado las pensiones y prestaciones a las que pudiera tener derecho",
    "Estar inscrito como demandante de empleo (si esta en edad laboral)",
    "No ser administrador de una sociedad mercantil"
  ],
  "documentos_necesarios": [
    "DNI/NIE de todos los miembros de la unidad de convivencia",
    "Certificado de empadronamiento",
    "Libro de familia o certificado de nacimiento",
    "Declaracion de la renta (o certificado de no obligacion)",
    "Certificado bancario de cuentas",
    "Certificado de demandante de empleo"
  ],
  "plazos": "Resolucion en 6 meses desde la solicitud. Silencio administrativo desestimatorio.",
  "tasas": null,
  "base_legal": ["Real Decreto-ley 20/2020, de 29 de mayo"],
  "como_solicitar": {
    "online": "Sede electronica de la Seguridad Social: sede.seg-social.gob.es",
    "presencial": "Oficinas de la Seguridad Social (CAISS) con cita previa",
    "telefono": "900 20 22 22 (gratuito) — linea IMV"
  },
  "donde_solicitar": {
    "urls": ["https://sede.seg-social.gob.es/"],
    "direcciones": ["Oficinas CAISS (consultar directorio)"],
    "cita_previa_url": null
  },
  "keywords": ["imv", "ingreso minimo", "renta minima", "ayuda economica", "prestacion", "604", "pobreza", "exclusion social"],
  "tags": ["social", "prestacion_economica", "vulnerable"],
  "idioma": "es",
  "idiomas_disponibles": ["es"],
  "extracted_at": "2026-02-18T00:00:00Z",
  "verified_at": "2026-02-18T00:00:00Z",
  "verified_by": "manual",
  "content_hash": "a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2",
  "word_count": 250,
  "completeness_score": 0.88,
  "version": 1
}
```

**Step 3: Commit**

```bash
mkdir -p "docs/arreglos chat/fase-3/q1-sources/evidence/samples"
git add schemas/ProcedureDoc.v1.schema.json "docs/arreglos chat/fase-3/q1-sources/evidence/samples/proceduredoc.sample.json"
git commit -m "feat(q1.1): add ProcedureDoc v1 JSON Schema + sample document"
```

---

### Task 7: Validation Scripts

**Files:**
- Create: `scripts/validate_source_registry.py`
- Create: `scripts/validate_policy.py`
- Create: `scripts/validate_proceduredoc_schema.py`
- Create: `tests/unit/test_validators.py`

**Step 1: Write the test file first (TDD)**

```python
"""Tests for Q1.1 validation scripts."""
import subprocess
import sys
import os

REPO = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


def _run(script: str, *args: str) -> subprocess.CompletedProcess:
    return subprocess.run(
        [sys.executable, os.path.join(REPO, "scripts", script), *args],
        capture_output=True,
        text=True,
        cwd=REPO,
    )


class TestValidateSourceRegistry:
    def test_registry_validates(self):
        r = _run("validate_source_registry.py")
        assert r.returncode == 0, f"FAIL: {r.stderr}"
        assert "PASS" in r.stdout

    def test_registry_has_age_sources(self):
        r = _run("validate_source_registry.py")
        assert "age:" in r.stdout.lower() or "AGE" in r.stdout

    def test_registry_has_ccaa_sources(self):
        r = _run("validate_source_registry.py")
        assert "ccaa:" in r.stdout.lower() or "CCAA" in r.stdout


class TestValidatePolicy:
    def test_policy_validates(self):
        r = _run("validate_policy.py")
        assert r.returncode == 0, f"FAIL: {r.stderr}"
        assert "PASS" in r.stdout


class TestValidateProcedureDoc:
    def test_sample_validates(self):
        sample = os.path.join(
            REPO,
            "docs",
            "arreglos chat",
            "fase-3",
            "q1-sources",
            "evidence",
            "samples",
            "proceduredoc.sample.json",
        )
        r = _run("validate_proceduredoc_schema.py", sample)
        assert r.returncode == 0, f"FAIL: {r.stderr}"
        assert "PASS" in r.stdout or "valid" in r.stdout.lower()
```

**Step 2: Run tests to verify they fail**

Run: `PYTHONPATH=. pytest tests/unit/test_validators.py -v`
Expected: FAIL (scripts don't exist yet)

**Step 3: Write scripts/validate_source_registry.py**

```python
#!/usr/bin/env python3
"""Validate data/sources/registry.yaml and local_seed.yaml against SourceRegistry schema."""
import json
import sys
from pathlib import Path

import yaml

try:
    import jsonschema
except ImportError:
    print("ERROR: pip install jsonschema")
    sys.exit(1)

REPO = Path(__file__).resolve().parent.parent
SCHEMA_PATH = REPO / "schemas" / "SourceRegistry.v1.schema.json"
REGISTRY_PATH = REPO / "data" / "sources" / "registry.yaml"
LOCAL_PATH = REPO / "data" / "sources" / "local_seed.yaml"


def load_yaml(path: Path) -> dict:
    with open(path) as f:
        return yaml.safe_load(f)


def load_json(path: Path) -> dict:
    with open(path) as f:
        return json.load(f)


def validate_file(data: dict, schema: dict, name: str) -> bool:
    try:
        jsonschema.validate(instance=data, schema=schema)
        print(f"  {name}: PASS (schema valid)")
        return True
    except jsonschema.ValidationError as e:
        print(f"  {name}: FAIL — {e.message}")
        print(f"    Path: {'.'.join(str(p) for p in e.absolute_path)}")
        return False


def main() -> int:
    print("=== Source Registry Validation ===\n")
    schema = load_json(SCHEMA_PATH)
    ok = True

    # Validate registry.yaml
    if REGISTRY_PATH.exists():
        data = load_yaml(REGISTRY_PATH)
        if not validate_file(data, schema, "registry.yaml"):
            ok = False
        sources = data.get("sources", [])
        age_count = sum(1 for s in sources if s.get("jurisdiction") == "age")
        ccaa_count = sum(1 for s in sources if s.get("jurisdiction") == "ccaa")
        print(f"  Sources: {len(sources)} total (AGE: {age_count}, CCAA: {ccaa_count})")
        if age_count < 20:
            print(f"  WARNING: AGE sources < 20 (got {age_count})")
        if ccaa_count < 17:
            print(f"  WARNING: CCAA sources < 17 (got {ccaa_count})")
    else:
        print(f"  registry.yaml: MISSING at {REGISTRY_PATH}")
        ok = False

    # Validate local_seed.yaml (uses same schema)
    if LOCAL_PATH.exists():
        data = load_yaml(LOCAL_PATH)
        if not validate_file(data, schema, "local_seed.yaml"):
            ok = False
        local_count = len(data.get("sources", []))
        print(f"  Local seeds: {local_count}")
        if local_count < 20:
            print(f"  WARNING: Local seeds < 20 (got {local_count})")
    else:
        print(f"  local_seed.yaml: MISSING at {LOCAL_PATH}")
        ok = False

    print()
    if ok:
        print("PASS: All source registry files valid.")
    else:
        print("FAIL: Validation errors found.")
    return 0 if ok else 1


if __name__ == "__main__":
    sys.exit(main())
```

**Step 4: Write scripts/validate_policy.py**

```python
#!/usr/bin/env python3
"""Validate data/policy/ YAML files for structural correctness."""
import sys
from pathlib import Path

import yaml

REPO = Path(__file__).resolve().parent.parent
POLICY_DIR = REPO / "data" / "policy"

REQUIRED_FILES = ["allowlist.yaml", "blocklist.yaml", "canonical_rules.yaml"]


def load_yaml(path: Path) -> dict:
    with open(path) as f:
        return yaml.safe_load(f)


def validate_allowlist(data: dict) -> list[str]:
    errors = []
    if "default_action" not in data:
        errors.append("Missing 'default_action' (should be 'reject')")
    if "tier_1_age" not in data:
        errors.append("Missing 'tier_1_age' section")
    elif len(data["tier_1_age"]) < 10:
        errors.append(f"tier_1_age has only {len(data['tier_1_age'])} domains (expected >= 10)")
    if "tier_2_ccaa" not in data:
        errors.append("Missing 'tier_2_ccaa' section")
    elif len(data["tier_2_ccaa"]) < 17:
        errors.append(f"tier_2_ccaa has only {len(data['tier_2_ccaa'])} entries (expected >= 17)")
    for tier in ["tier_1_age", "tier_2_ccaa", "tier_3_municipal"]:
        for entry in data.get(tier, []):
            if "domain" not in entry:
                errors.append(f"Entry in {tier} missing 'domain' field: {entry}")
    return errors


def validate_blocklist(data: dict) -> list[str]:
    errors = []
    if "categories" not in data:
        errors.append("Missing 'categories' section")
    else:
        for cat in data["categories"]:
            if "category" not in cat:
                errors.append(f"Category entry missing 'category' field")
            if "domains" not in cat or not cat["domains"]:
                errors.append(f"Category '{cat.get('category', '?')}' has no domains")
    if "patterns" not in data:
        errors.append("Missing 'patterns' section (glob patterns like *.wordpress.com)")
    return errors


def validate_canonical(data: dict) -> list[str]:
    errors = []
    if "rules" not in data:
        errors.append("Missing 'rules' section")
    elif len(data["rules"]) < 10:
        errors.append(f"Only {len(data['rules'])} rules (expected 10)")
    if "tracking_params_strip" not in data:
        errors.append("Missing 'tracking_params_strip'")
    if "session_params_strip" not in data:
        errors.append("Missing 'session_params_strip'")
    return errors


def main() -> int:
    print("=== Policy Validation ===\n")
    ok = True

    for fname in REQUIRED_FILES:
        path = POLICY_DIR / fname
        if not path.exists():
            print(f"  {fname}: MISSING")
            ok = False
            continue
        data = load_yaml(path)

        if fname == "allowlist.yaml":
            errors = validate_allowlist(data)
        elif fname == "blocklist.yaml":
            errors = validate_blocklist(data)
        elif fname == "canonical_rules.yaml":
            errors = validate_canonical(data)
        else:
            errors = []

        if errors:
            print(f"  {fname}: FAIL")
            for e in errors:
                print(f"    - {e}")
            ok = False
        else:
            print(f"  {fname}: PASS")

    print()
    if ok:
        print("PASS: All policy files valid.")
    else:
        print("FAIL: Policy validation errors found.")
    return 0 if ok else 1


if __name__ == "__main__":
    sys.exit(main())
```

**Step 5: Write scripts/validate_proceduredoc_schema.py**

```python
#!/usr/bin/env python3
"""Validate a ProcedureDoc JSON file against ProcedureDoc.v1.schema.json."""
import json
import sys
from pathlib import Path

try:
    import jsonschema
except ImportError:
    print("ERROR: pip install jsonschema")
    sys.exit(1)

REPO = Path(__file__).resolve().parent.parent
SCHEMA_PATH = REPO / "schemas" / "ProcedureDoc.v1.schema.json"


def main() -> int:
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <path-to-proceduredoc.json>")
        return 1

    doc_path = Path(sys.argv[1])
    if not doc_path.exists():
        print(f"ERROR: File not found: {doc_path}")
        return 1

    with open(SCHEMA_PATH) as f:
        schema = json.load(f)
    with open(doc_path) as f:
        doc = json.load(f)

    try:
        jsonschema.validate(instance=doc, schema=schema)
        print(f"PASS: {doc_path.name} is valid against ProcedureDoc v1 schema.")
        print(f"  id: {doc.get('id')}")
        print(f"  nombre: {doc.get('nombre')}")
        print(f"  completeness_score: {doc.get('completeness_score')}")
        return 0
    except jsonschema.ValidationError as e:
        print(f"FAIL: {doc_path.name}")
        print(f"  Error: {e.message}")
        print(f"  Path: {'.'.join(str(p) for p in e.absolute_path)}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
```

**Step 6: Run tests**

Run: `PYTHONPATH=. pytest tests/unit/test_validators.py -v --tb=short`
Expected: All PASS

**Step 7: Commit**

```bash
git add scripts/validate_source_registry.py scripts/validate_policy.py scripts/validate_proceduredoc_schema.py tests/unit/test_validators.py
git commit -m "feat(q1.1): add validation scripts + tests for registry, policy, ProcedureDoc"
```

---

### Task 8: Link Checker Skeleton

**Files:**
- Create: `scripts/link_check.py`
- Create: `docs/arreglos chat/fase-3/q1-sources/evidence/samples/link_check_output.sample.jsonl`
- Create: `docs/arreglos chat/fase-3/q1-sources/evidence/samples/registry.sample.yaml`

**Step 1: Write scripts/link_check.py**

```python
#!/usr/bin/env python3
"""
Link health checker skeleton.

Usage:
    python3 scripts/link_check.py [--smoke] [--limit N] [--output PATH]

Options:
    --smoke     Run against top P0 sources only (~20-30 URLs)
    --limit N   Max URLs to check (default: 50)
    --output    Path for JSONL output (default: stdout)
"""
import argparse
import json
import sys
import time
import urllib.request
import urllib.error
from datetime import datetime, timezone
from pathlib import Path

import yaml

REPO = Path(__file__).resolve().parent.parent
REGISTRY_PATH = REPO / "data" / "sources" / "registry.yaml"
LOCAL_PATH = REPO / "data" / "sources" / "local_seed.yaml"


def load_urls_from_registry(smoke: bool = False) -> list[dict]:
    """Extract URLs from registry.yaml + local_seed.yaml."""
    urls = []

    for path in [REGISTRY_PATH, LOCAL_PATH]:
        if not path.exists():
            print(f"WARNING: {path.name} not found, skipping", file=sys.stderr)
            continue
        with open(path) as f:
            data = yaml.safe_load(f)
        for source in data.get("sources", []):
            if smoke and source.get("priority") not in ("P0",):
                continue
            source_id = source.get("id", "unknown")
            tier = source.get("tier", 0)
            rate = source.get("rate_limit_rps", 1.0)
            for url_field in ["portal_url", "sede_url", "catalogo_url", "api_url"]:
                url = source.get(url_field)
                if url:
                    urls.append({
                        "url": url,
                        "source_id": source_id,
                        "url_field": url_field,
                        "tier": tier,
                        "rate_limit_rps": rate,
                    })
    return urls


def check_url(url: str, timeout: int = 30) -> dict:
    """Check a single URL via HTTP HEAD (fallback GET)."""
    result = {
        "url": url,
        "final_url": url,
        "status_code": None,
        "checked_at": datetime.now(timezone.utc).isoformat(),
        "redirect_chain": [],
        "response_time_ms": None,
        "failure_reason": None,
    }

    try:
        req = urllib.request.Request(url, method="HEAD")
        req.add_header("User-Agent", "ClaraBot/1.0 (CivicAid; link-checker)")
        start = time.monotonic()
        with urllib.request.urlopen(req, timeout=timeout) as resp:
            elapsed = (time.monotonic() - start) * 1000
            result["status_code"] = resp.status
            result["final_url"] = resp.url
            result["response_time_ms"] = round(elapsed, 1)
    except urllib.error.HTTPError as e:
        result["status_code"] = e.code
        result["failure_reason"] = str(e.reason)
    except urllib.error.URLError as e:
        result["failure_reason"] = str(e.reason)
    except Exception as e:
        result["failure_reason"] = f"{type(e).__name__}: {e}"

    return result


def main() -> int:
    parser = argparse.ArgumentParser(description="Link health checker for CivicAid sources")
    parser.add_argument("--smoke", action="store_true", help="Check P0 sources only")
    parser.add_argument("--limit", type=int, default=50, help="Max URLs to check")
    parser.add_argument("--output", type=str, help="Output JSONL path (default: stdout)")
    parser.add_argument("--dry-run", action="store_true", help="List URLs without checking")
    args = parser.parse_args()

    urls = load_urls_from_registry(smoke=args.smoke)
    urls = urls[: args.limit]

    print(f"Link checker: {len(urls)} URLs to check (smoke={args.smoke}, limit={args.limit})", file=sys.stderr)

    if args.dry_run:
        for entry in urls:
            print(f"  [{entry['source_id']}] {entry['url']}", file=sys.stderr)
        return 0

    out = open(args.output, "w") if args.output else sys.stdout
    ok_count = 0
    fail_count = 0
    last_domain = None

    for i, entry in enumerate(urls):
        # Basic rate limiting: 1 sec between requests to same domain
        domain = urllib.request.urlparse(entry["url"]).netloc if hasattr(urllib.request, "urlparse") else ""
        try:
            from urllib.parse import urlparse
            domain = urlparse(entry["url"]).netloc
        except Exception:
            domain = ""

        if domain == last_domain:
            time.sleep(1.0 / entry.get("rate_limit_rps", 1.0))
        last_domain = domain

        result = check_url(entry["url"])
        result["source_id"] = entry["source_id"]
        result["url_field"] = entry["url_field"]
        result["tier"] = entry["tier"]

        status = result["status_code"]
        if status and 200 <= status < 400:
            ok_count += 1
            icon = "OK"
        else:
            fail_count += 1
            icon = "FAIL"

        print(f"  [{i+1}/{len(urls)}] {icon} {status or 'ERR'} {entry['url'][:80]}", file=sys.stderr)
        out.write(json.dumps(result, ensure_ascii=False) + "\n")

    if args.output:
        out.close()

    print(f"\nResults: {ok_count} OK, {fail_count} FAIL, {len(urls)} total", file=sys.stderr)
    return 0 if fail_count == 0 else 1


if __name__ == "__main__":
    sys.exit(main())
```

**Step 2: Create sample output**

Create file: `docs/arreglos chat/fase-3/q1-sources/evidence/samples/link_check_output.sample.jsonl`

```jsonl
{"url": "https://administracion.gob.es/", "final_url": "https://administracion.gob.es/", "status_code": 200, "checked_at": "2026-02-18T12:00:00Z", "redirect_chain": [], "response_time_ms": 350.2, "failure_reason": null, "source_id": "age-sia-pag", "url_field": "portal_url", "tier": 1}
{"url": "https://www.boe.es/", "final_url": "https://www.boe.es/", "status_code": 200, "checked_at": "2026-02-18T12:00:01Z", "redirect_chain": [], "response_time_ms": 210.5, "failure_reason": null, "source_id": "age-boe-diario", "url_field": "portal_url", "tier": 1}
{"url": "https://sede.sepe.gob.es/", "final_url": "https://sede.sepe.gob.es/", "status_code": 200, "checked_at": "2026-02-18T12:00:02Z", "redirect_chain": [], "response_time_ms": 580.1, "failure_reason": null, "source_id": "age-sepe", "url_field": "sede_url", "tier": 1}
```

**Step 3: Create registry sample**

Create file: `docs/arreglos chat/fase-3/q1-sources/evidence/samples/registry.sample.yaml`

```yaml
# Sample: first 3 entries from registry.yaml showing the format
version: "1.0"
generated_at: "2026-02-18"
sources:
  - id: age-sia-pag
    name: "SIA / Punto de Acceso General"
    name_abbrev: "SIA/PAG"
    jurisdiction: age
    tier: 1
    priority: P0
    portal_url: "https://administracion.gob.es/"
    sede_url: "https://sede.administracion.gob.es/"
    access_method: crawl
    content_formats: [html]
    languages: [es]
    rate_limit_rps: 1.0
    update_frequency: continuous
    coverage: "Master catalog of ALL administrative procedures across AGE"

  - id: ccaa-madrid
    name: "Comunidad de Madrid"
    jurisdiction: ccaa
    ccaa_code: madrid
    tier: 2
    priority: P0
    portal_url: "https://www.comunidad.madrid/"
    sede_url: "https://sede.comunidad.madrid/"
    access_method: crawl
    content_formats: [html, pdf]
    languages: [es]
    rate_limit_rps: 1.0
    update_frequency: monthly
    coverage: "Regional procedures: healthcare, education, social services, housing"

  - id: local-madrid
    name: "Ayuntamiento de Madrid"
    jurisdiction: local
    municipality: Madrid
    province: Madrid
    tier: 3
    priority: P0
    portal_url: "https://sede.madrid.es/"
    sede_url: "https://sede.madrid.es/"
    catalogo_url: "https://sede.madrid.es/portal/site/tramites"
    access_method: crawl
    content_formats: [html, pdf]
    languages: [es]
    rate_limit_rps: 1.0
    update_frequency: monthly
    coverage: "Municipal procedures: empadronamiento, IBI, licencias"
```

**Step 4: Commit**

```bash
git add scripts/link_check.py "docs/arreglos chat/fase-3/q1-sources/evidence/samples/"
git commit -m "feat(q1.1): add link checker skeleton + sample outputs"
```

---

### Task 9: Documentation, Report, and Gates Evidence

**Files:**
- Create: `docs/arreglos chat/fase-3/q1-sources/Q1.1-BIBLIOTECA-OFICIAL-v0-REPORT.md`
- Modify: `docs/arreglos chat/fase-3/q1-sources/evidence/gates.md`
- Modify: `docs/arreglos chat/README.md`
- Modify: `docs/arreglos chat/fase-3/README.md`
- Create/Update: `docs/arreglos chat/fase-3/q1-sources/backlog/Q1-backlog.md` (add Q1.1 items)

**Step 1: Run all gates and capture output**

```bash
# Gate G1: Registry validation
python3 scripts/validate_source_registry.py

# Gate G2: Policy validation
python3 scripts/validate_policy.py

# Gate G3: ProcedureDoc schema validation
python3 scripts/validate_proceduredoc_schema.py "docs/arreglos chat/fase-3/q1-sources/evidence/samples/proceduredoc.sample.json"

# Gate G4: Link checker smoke (dry-run first, then real)
python3 scripts/link_check.py --smoke --limit 10 --dry-run
python3 scripts/link_check.py --smoke --limit 10 --output /tmp/link_check_smoke.jsonl

# Gate G5: Verify docs exist
ls -la data/sources/README.md data/policy/README.md schemas/README.md

# Gate G6: Verify backlog updated
cat "docs/arreglos chat/fase-3/q1-sources/backlog/Q1-backlog.md"

# Run tests
PYTHONPATH=. pytest tests/unit/test_validators.py -v --tb=short
```

**Step 2: Write Q1.1-BIBLIOTECA-OFICIAL-v0-REPORT.md**

This report should contain:
- Executive summary (what was done, why, scope)
- Files created table (path, description, line count)
- Source counts table (AGE: 25, CCAA: 19, Local: 20, Total: 64)
- Gates table (G1-G6 with PASS/FAIL and evidence commands)
- Abort conditions table (A1-A4 with CLEARED status)
- How to use section (commands for each validator)
- Backlog (what carries to Q2)

**Step 3: Update gates.md**

Append Q1.1 gates to the existing Q1 gates file, or create a new section.

**Step 4: Update README.md and fase-3/README.md**

Add Q1.1 section with links to new artifacts.

**Step 5: Update backlog**

Add completed Q1.1 items and any new carry items to `Q1-backlog.md`.

**Step 6: Commit**

```bash
git add "docs/arreglos chat/" data/sources/ data/policy/ schemas/ scripts/ tests/
git commit -m "feat(q1.1): Biblioteca Oficial v0 — report, gates, docs update"
```

---

## Summary of All Files

### New Files (19):
```
data/sources/registry.yaml               # 44 sources (25 AGE + 19 CCAA)
data/sources/local_seed.yaml             # 20 municipal sedes
data/sources/README.md                   # How to add sources
data/policy/allowlist.yaml               # 3-tier domain allowlist
data/policy/blocklist.yaml               # Blocked domains by category
data/policy/canonical_rules.yaml         # 10 URL normalization rules
data/policy/README.md                    # How policy is applied
schemas/SourceRegistry.v1.schema.json    # JSON Schema for registry
schemas/ProcedureDoc.v1.schema.json      # JSON Schema for procedures
schemas/README.md                        # Schema overview
scripts/validate_source_registry.py      # Registry validator
scripts/validate_policy.py               # Policy validator
scripts/validate_proceduredoc_schema.py  # ProcedureDoc validator
scripts/link_check.py                    # Link health checker skeleton
tests/unit/test_validators.py            # Tests for validators
docs/.../evidence/samples/proceduredoc.sample.json
docs/.../evidence/samples/link_check_output.sample.jsonl
docs/.../evidence/samples/registry.sample.yaml
docs/.../Q1.1-BIBLIOTECA-OFICIAL-v0-REPORT.md
```

### Modified Files (3):
```
docs/arreglos chat/README.md
docs/arreglos chat/fase-3/README.md
docs/arreglos chat/fase-3/q1-sources/backlog/Q1-backlog.md
```

### Gate Commands:
```bash
python3 scripts/validate_source_registry.py          # G1
python3 scripts/validate_policy.py                    # G2
python3 scripts/validate_proceduredoc_schema.py \
  "docs/arreglos chat/fase-3/q1-sources/evidence/samples/proceduredoc.sample.json"  # G3
python3 scripts/link_check.py --smoke --limit 10      # G4
PYTHONPATH=. pytest tests/unit/test_validators.py -v   # All
```
